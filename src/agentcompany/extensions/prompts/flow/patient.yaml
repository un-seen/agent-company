database:
  primary_id: patient
  description: a collection of patients who have undergone mammography
  tables:
    - name: dicom_instance
      columns:
        - name: dicom_path
          description: The path to the mammogram's dicom png file.
        - name: study_date
          description: The date of the mammogram.
        - name: patient_id
          description: The id of the patient who has undergone mammography.
    - name: note_structured
      columns:
        - name: patient
          description: The id of the patient 
        - name: note_date
          description: The date on which the note was created.
        - name: type
          description: The type of the note created. It is either treatment, recurrence or biomarker. 
        - name: abstraction
          description: Any abstraction value associated with the note type. In the case of treatment and recurrence it is irrelevant.
            But if the note type is biomarker, the abstraction can be estrogen_receptor, progesterone_receptor or her2.
        - name: interpretation
          description: The interpretation of the note abstraction. It is only relevant if note type is biomarker. 
            It is 'positive' if the biomarker is present and 'negative' if the biomarker is absent.
    - name: patient
      columns:
        - name: dob
          description: The date of birth of the patient.
        - name: ethnicity
          description: The ethnicity of the patient.
        - name: first_3_zip
          description: The first 3 digits of the zip code of the patient.
        - name: gender
          description: The gender of the patient.
        - name: id
          description: The id of the patient.
        - name: marital_status
          description: The marital status of the patient.
hint:
  - task: Creates view of patients diagnosed with estrogen_receptor positive or progesterone_receptor positive and her2 negative
    keyword: 
      - estrogen_receptor
      - progesterone_receptor
      - her2
    sql: |-
      CREATE OR REPLACE VIEW diagnosis_agent_view AS
      SELECT DISTINCT ON (patient)
          patient,
          note_date as diagnosis_date,
          note as diagnosis_note
      FROM (
          SELECT ns.*
          FROM note_structured ns
          JOIN (
              SELECT note
              FROM note_structured
              WHERE LOWER(abstraction) = 'her2' 
              AND interpretation = 'negative'
          ) her2 ON ns.note = her2.note
          WHERE (ns.abstraction = 'estrogen_receptor' AND ns.interpretation = 'positive')
            OR (ns.abstraction = 'progesterone_receptor' AND ns.interpretation = 'positive')
      ) dx
      ORDER BY patient, note_date;
  - task: Creates view of patients diagnosed with estrogen_receptor positive or progesterone_receptor positive and her2 negative with treatment within 90 days
    keyword: 
      - estrogen_receptor
      - progesterone_receptor
      - her2
    sql: |-
      CREATE OR REPLACE VIEW treatment_agent_view AS
        SELECT DISTINCT ON (t.patient)
            t.patient,
            t.note_date as treatment_date,
            t.note as treatment_note
        FROM note_structured t
        JOIN diagnosis_agent_view d ON t.patient = d.patient
        WHERE t.type = 'treatment'
        AND t.interpretation = 'positive'
        AND t.note_date > d.diagnosis_date
        AND t.note_date <= (d.diagnosis_date + INTERVAL '90 days')
        ORDER BY t.patient, t.note_date;
  - task: Creates view of patients diagnosed with estrogen_receptor positive or progesterone_receptor positive and her2 negative with treatment within 90 days and had recurrence within a year
    keyword: 
      - estrogen_receptor
      - progesterone_receptor
      - her2
    sql: |-
      CREATE OR REPLACE VIEW recurrence_agent_view AS
        SELECT DISTINCT ON (r.patient)
            r.patient,
            r.note_date as recurrence_date,
            r.note as recurrence_note
        FROM note_structured r
        JOIN treatment_agent_view t ON r.patient = t.patient
        WHERE r.type = 'recurrence'
        AND r.interpretation = 'positive'
        AND r.note_date > t.treatment_date
        AND r.note_date <= (t.treatment_date + INTERVAL '1 year')
        ORDER BY r.patient, r.note_date;
  - task: Creates view of patients diagnosed with estrogen_receptor positive or progesterone_receptor positive and her2 negative with treatment within 90 days and had recurrence within a year and had an MRI within 90 days prior to treatment
    keyword: 
      - estrogen_receptor
      - progesterone_receptor
      - her2
    sql: |-
      CREATE OR REPLACE VIEW mri_agent_view AS
        SELECT DISTINCT ON (rs.patient)
            rs.patient,
            rs.report_date,
            rs.report
        FROM report_structured rs
        JOIN recurrence_agent_view r ON rs.patient = r.patient
        JOIN treatment_agent_view et ON rs.patient = et.patient
        WHERE rs.desc IN (
            'MRI Breast w/ + w/o Contrast Bilateral',
            'BI MR BREAST BILATERAL W AND WO CONTRAST'
        )
        AND rs.vtype IN ('H', 'G', 'A', 'F', 'K', 'P', 'S', 'V')
        AND rs.report_date >= (et.treatment_date - INTERVAL '90 days')
        AND rs.report_date < et.treatment_date
        ORDER BY rs.patient, rs.report_date DESC;
  - task: I need the pre-treatment MRI for patients who have ER or PR +, HER2 - disease who had cancer recurrence within 1 year
    keyword:
      - estrogen_receptor
      - progesterone_receptor
      - her2
    sql: |-
        SELECT 
            d.patient,
            d.diagnosis_date,
            d.diagnosis_note,
            t.treatment_date,
            t.treatment_note,
            r.recurrence_date,
            r.recurrence_note,
            m.report_date as mri_date,
            m.report
        FROM diagnosis_agent_view d
        INNER JOIN treatment_agent_view t ON d.patient = t.patient
        INNER JOIN recurrence_agent_view r ON d.patient = r.patient
        INNER JOIN mri_agent_view m ON d.patient = m.patient
        ORDER BY d.patient

